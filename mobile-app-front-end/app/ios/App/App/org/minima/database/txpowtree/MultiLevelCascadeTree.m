//
//  Generated by the J2ObjC translator.  DO NOT EDIT!
//  source: ./org/minima/database/txpowtree/MultiLevelCascadeTree.java
//

#include "J2ObjC_source.h"
#include "java/io/PrintStream.h"
#include "java/lang/System.h"
#include "java/util/ArrayList.h"
#include "org/minima/GlobalParams.h"
#include "org/minima/database/mmr/MMRSet.h"
#include "org/minima/database/txpowtree/BlockTree.h"
#include "org/minima/database/txpowtree/BlockTreeNode.h"
#include "org/minima/database/txpowtree/MultiLevelCascadeTree.h"
#include "org/minima/objects/TxPOW.h"
#include "org/minima/objects/base/MiniNumber.h"

@interface OrgMinimaDatabaseTxpowtreeMultiLevelCascadeTree ()

- (OrgMinimaDatabaseTxpowtreeBlockTreeNode *)copyNodeTreeWithOrgMinimaDatabaseTxpowtreeBlockTreeNode:(OrgMinimaDatabaseTxpowtreeBlockTreeNode *)zOriginal OBJC_METHOD_FAMILY_NONE;

@end

__attribute__((unused)) static OrgMinimaDatabaseTxpowtreeBlockTreeNode *OrgMinimaDatabaseTxpowtreeMultiLevelCascadeTree_copyNodeTreeWithOrgMinimaDatabaseTxpowtreeBlockTreeNode_(OrgMinimaDatabaseTxpowtreeMultiLevelCascadeTree *self, OrgMinimaDatabaseTxpowtreeBlockTreeNode *zOriginal);

@implementation OrgMinimaDatabaseTxpowtreeMultiLevelCascadeTree

- (instancetype)initWithOrgMinimaDatabaseTxpowtreeBlockTree:(OrgMinimaDatabaseTxpowtreeBlockTree *)zMainTree {
  OrgMinimaDatabaseTxpowtreeMultiLevelCascadeTree_initWithOrgMinimaDatabaseTxpowtreeBlockTree_(self, zMainTree);
  return self;
}

- (OrgMinimaDatabaseTxpowtreeBlockTree *)getCascadeTree {
  return mCascadeTree_;
}

- (JavaUtilArrayList *)getRemoved {
  return mRemovals_;
}

- (void)recurseParentMMRWithOrgMinimaObjectsBaseMiniNumber:(OrgMinimaObjectsBaseMiniNumber *)zCascade
                            withOrgMinimaDatabaseMmrMMRSet:(OrgMinimaDatabaseMmrMMRSet *)zNode {
  if ([((OrgMinimaObjectsBaseMiniNumber *) nil_chk([((OrgMinimaDatabaseMmrMMRSet *) nil_chk(zNode)) getBlockTime])) isMoreWithOrgMinimaObjectsBaseMiniNumber:[((OrgMinimaObjectsBaseMiniNumber *) nil_chk(zCascade)) increment]]) {
    if ([zNode getParent] == nil) {
      [((JavaIoPrintStream *) nil_chk(JreLoadStatic(JavaLangSystem, out))) printlnWithNSString:JreStrcat("$@$@", @"RECURSE TREE NULL PARENT : CASC:", zCascade, @" BLKTIME:", [zNode getBlockTime])];
    }
    else {
      [self recurseParentMMRWithOrgMinimaObjectsBaseMiniNumber:zCascade withOrgMinimaDatabaseMmrMMRSet:[zNode getParent]];
    }
  }
  [zNode copyParentKeepers];
}

- (JavaUtilArrayList *)cascadedTree {
  JreStrongAssignAndConsume(&mRemovals_, new_JavaUtilArrayList_init());
  JreStrongAssignAndConsume(&mCascadeTree_, new_OrgMinimaDatabaseTxpowtreeBlockTree_init());
  OrgMinimaDatabaseTxpowtreeBlockTreeNode *oldtip = [((OrgMinimaDatabaseTxpowtreeBlockTree *) nil_chk(mMainTree_)) getChainTip];
  OrgMinimaObjectsBaseMiniNumber *casc = [((OrgMinimaObjectsTxPOW *) nil_chk([((OrgMinimaDatabaseTxpowtreeBlockTreeNode *) nil_chk([((OrgMinimaDatabaseTxpowtreeBlockTree *) nil_chk(mMainTree_)) getCascadeNode])) getTxPow])) getBlockNumber];
  jint counter = 0;
  while ((oldtip != nil) && (counter < OrgMinimaGlobalParams_MINIMA_CASCADE_START_DEPTH) && ([((OrgMinimaObjectsBaseMiniNumber *) nil_chk([((OrgMinimaObjectsTxPOW *) nil_chk([((OrgMinimaDatabaseTxpowtreeBlockTreeNode *) nil_chk(oldtip)) getTxPow])) getBlockNumber])) isMoreWithOrgMinimaObjectsBaseMiniNumber:casc])) {
    counter++;
    oldtip = [((OrgMinimaDatabaseTxpowtreeBlockTreeNode *) nil_chk(oldtip)) getParent];
  }
  if (oldtip == nil) {
    JreStrongAssign(&mCascadeTree_, mMainTree_);
    return mRemovals_;
  }
  OrgMinimaDatabaseTxpowtreeBlockTreeNode *fullkeep = OrgMinimaDatabaseTxpowtreeMultiLevelCascadeTree_copyNodeTreeWithOrgMinimaDatabaseTxpowtreeBlockTreeNode_(self, oldtip);
  OrgMinimaDatabaseTxpowtreeBlockTreeNode *newcascade = [oldtip getParent];
  JavaUtilArrayList *cascnodes = create_JavaUtilArrayList_init();
  while (newcascade != nil) {
    OrgMinimaDatabaseTxpowtreeBlockTreeNode *node = create_OrgMinimaDatabaseTxpowtreeBlockTreeNode_initWithOrgMinimaDatabaseTxpowtreeBlockTreeNode_(newcascade);
    [node setCascadeWithBoolean:true];
    [node setStateWithInt:OrgMinimaDatabaseTxpowtreeBlockTreeNode_BLOCKSTATE_VALID];
    [cascnodes addWithId:node];
    newcascade = [newcascade getParent];
  }
  JavaUtilArrayList *finalnodes = create_JavaUtilArrayList_init();
  jint casclevel = 0;
  jint totlevel = 0;
  jboolean moveup = false;
  for (OrgMinimaDatabaseTxpowtreeBlockTreeNode * __strong node in cascnodes) {
    jint superlev = [((OrgMinimaDatabaseTxpowtreeBlockTreeNode *) nil_chk(node)) getSuperBlockLevel];
    if (superlev >= casclevel) {
      [node setCurrentLevelWithInt:casclevel];
      [finalnodes addWithInt:0 withId:node];
      totlevel++;
      if (totlevel > OrgMinimaGlobalParams_MINIMA_MINUMUM_CASCADE_LEVEL_NODES) {
        moveup = true;
      }
      if (moveup && (superlev > casclevel)) {
        casclevel++;
        [node setCurrentLevelWithInt:casclevel];
        totlevel = 1;
        moveup = false;
      }
    }
    else {
      [((JavaUtilArrayList *) nil_chk(mRemovals_)) addWithId:node];
    }
  }
  for (OrgMinimaDatabaseTxpowtreeBlockTreeNode * __strong node in finalnodes) {
    OrgMinimaDatabaseTxpowtreeBlockTreeNode *copy_ = create_OrgMinimaDatabaseTxpowtreeBlockTreeNode_initWithOrgMinimaDatabaseTxpowtreeBlockTreeNode_(node);
    [((OrgMinimaDatabaseTxpowtreeBlockTree *) nil_chk(mCascadeTree_)) hardAddNodeWithOrgMinimaDatabaseTxpowtreeBlockTreeNode:copy_ withBoolean:false];
    [((OrgMinimaDatabaseTxpowtreeBlockTree *) nil_chk(mCascadeTree_)) hardSetCascadeNodeWithOrgMinimaDatabaseTxpowtreeBlockTreeNode:copy_];
  }
  [((OrgMinimaDatabaseTxpowtreeBlockTree *) nil_chk(mCascadeTree_)) hardAddNodeWithOrgMinimaDatabaseTxpowtreeBlockTreeNode:fullkeep withBoolean:false];
  [((OrgMinimaDatabaseTxpowtreeBlockTree *) nil_chk(mCascadeTree_)) resetWeights];
  return mRemovals_;
}

- (OrgMinimaDatabaseTxpowtreeBlockTreeNode *)copyNodeTreeWithOrgMinimaDatabaseTxpowtreeBlockTreeNode:(OrgMinimaDatabaseTxpowtreeBlockTreeNode *)zOriginal {
  return OrgMinimaDatabaseTxpowtreeMultiLevelCascadeTree_copyNodeTreeWithOrgMinimaDatabaseTxpowtreeBlockTreeNode_(self, zOriginal);
}

- (void)dealloc {
  RELEASE_(mMainTree_);
  RELEASE_(mCascadeTree_);
  RELEASE_(mRemovals_);
  [super dealloc];
}

+ (const J2ObjcClassInfo *)__metadata {
  static J2ObjcMethodInfo methods[] = {
    { NULL, NULL, 0x1, -1, 0, -1, -1, -1, -1 },
    { NULL, "LOrgMinimaDatabaseTxpowtreeBlockTree;", 0x1, -1, -1, -1, -1, -1, -1 },
    { NULL, "LJavaUtilArrayList;", 0x1, -1, -1, -1, 1, -1, -1 },
    { NULL, "V", 0x1, 2, 3, -1, -1, -1, -1 },
    { NULL, "LJavaUtilArrayList;", 0x1, -1, -1, -1, 1, -1, -1 },
    { NULL, "LOrgMinimaDatabaseTxpowtreeBlockTreeNode;", 0x2, 4, 5, -1, -1, -1, -1 },
  };
  #pragma clang diagnostic push
  #pragma clang diagnostic ignored "-Wobjc-multiple-method-names"
  #pragma clang diagnostic ignored "-Wundeclared-selector"
  methods[0].selector = @selector(initWithOrgMinimaDatabaseTxpowtreeBlockTree:);
  methods[1].selector = @selector(getCascadeTree);
  methods[2].selector = @selector(getRemoved);
  methods[3].selector = @selector(recurseParentMMRWithOrgMinimaObjectsBaseMiniNumber:withOrgMinimaDatabaseMmrMMRSet:);
  methods[4].selector = @selector(cascadedTree);
  methods[5].selector = @selector(copyNodeTreeWithOrgMinimaDatabaseTxpowtreeBlockTreeNode:);
  #pragma clang diagnostic pop
  static const J2ObjcFieldInfo fields[] = {
    { "mMainTree_", "LOrgMinimaDatabaseTxpowtreeBlockTree;", .constantValue.asLong = 0, 0x0, -1, -1, -1, -1 },
    { "mCascadeTree_", "LOrgMinimaDatabaseTxpowtreeBlockTree;", .constantValue.asLong = 0, 0x0, -1, -1, -1, -1 },
    { "mRemovals_", "LJavaUtilArrayList;", .constantValue.asLong = 0, 0x0, -1, -1, 6, -1 },
  };
  static const void *ptrTable[] = { "LOrgMinimaDatabaseTxpowtreeBlockTree;", "()Ljava/util/ArrayList<Lorg/minima/database/txpowtree/BlockTreeNode;>;", "recurseParentMMR", "LOrgMinimaObjectsBaseMiniNumber;LOrgMinimaDatabaseMmrMMRSet;", "copyNodeTree", "LOrgMinimaDatabaseTxpowtreeBlockTreeNode;", "Ljava/util/ArrayList<Lorg/minima/database/txpowtree/BlockTreeNode;>;" };
  static const J2ObjcClassInfo _OrgMinimaDatabaseTxpowtreeMultiLevelCascadeTree = { "MultiLevelCascadeTree", "org.minima.database.txpowtree", ptrTable, methods, fields, 7, 0x1, 6, 3, -1, -1, -1, -1, -1 };
  return &_OrgMinimaDatabaseTxpowtreeMultiLevelCascadeTree;
}

@end

void OrgMinimaDatabaseTxpowtreeMultiLevelCascadeTree_initWithOrgMinimaDatabaseTxpowtreeBlockTree_(OrgMinimaDatabaseTxpowtreeMultiLevelCascadeTree *self, OrgMinimaDatabaseTxpowtreeBlockTree *zMainTree) {
  NSObject_init(self);
  JreStrongAssign(&self->mMainTree_, zMainTree);
  JreStrongAssignAndConsume(&self->mRemovals_, new_JavaUtilArrayList_init());
}

OrgMinimaDatabaseTxpowtreeMultiLevelCascadeTree *new_OrgMinimaDatabaseTxpowtreeMultiLevelCascadeTree_initWithOrgMinimaDatabaseTxpowtreeBlockTree_(OrgMinimaDatabaseTxpowtreeBlockTree *zMainTree) {
  J2OBJC_NEW_IMPL(OrgMinimaDatabaseTxpowtreeMultiLevelCascadeTree, initWithOrgMinimaDatabaseTxpowtreeBlockTree_, zMainTree)
}

OrgMinimaDatabaseTxpowtreeMultiLevelCascadeTree *create_OrgMinimaDatabaseTxpowtreeMultiLevelCascadeTree_initWithOrgMinimaDatabaseTxpowtreeBlockTree_(OrgMinimaDatabaseTxpowtreeBlockTree *zMainTree) {
  J2OBJC_CREATE_IMPL(OrgMinimaDatabaseTxpowtreeMultiLevelCascadeTree, initWithOrgMinimaDatabaseTxpowtreeBlockTree_, zMainTree)
}

OrgMinimaDatabaseTxpowtreeBlockTreeNode *OrgMinimaDatabaseTxpowtreeMultiLevelCascadeTree_copyNodeTreeWithOrgMinimaDatabaseTxpowtreeBlockTreeNode_(OrgMinimaDatabaseTxpowtreeMultiLevelCascadeTree *self, OrgMinimaDatabaseTxpowtreeBlockTreeNode *zOriginal) {
  OrgMinimaDatabaseTxpowtreeBlockTreeNode *copy_ = create_OrgMinimaDatabaseTxpowtreeBlockTreeNode_initWithOrgMinimaDatabaseTxpowtreeBlockTreeNode_(zOriginal);
  JavaUtilArrayList *children = [((OrgMinimaDatabaseTxpowtreeBlockTreeNode *) nil_chk(zOriginal)) getChildren];
  for (OrgMinimaDatabaseTxpowtreeBlockTreeNode * __strong child in nil_chk(children)) {
    OrgMinimaDatabaseTxpowtreeBlockTreeNode *childcopy = OrgMinimaDatabaseTxpowtreeMultiLevelCascadeTree_copyNodeTreeWithOrgMinimaDatabaseTxpowtreeBlockTreeNode_(self, child);
    [copy_ addChildWithOrgMinimaDatabaseTxpowtreeBlockTreeNode:childcopy];
  }
  return copy_;
}

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(OrgMinimaDatabaseTxpowtreeMultiLevelCascadeTree)
