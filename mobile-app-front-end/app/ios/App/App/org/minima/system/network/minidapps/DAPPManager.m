//
//  Generated by the J2ObjC translator.  DO NOT EDIT!
//  source: ./org/minima/system/network/minidapps/DAPPManager.java
//

#include "IOSObjectArray.h"
#include "IOSPrimitiveArray.h"
#include "J2ObjC_source.h"
#include "java/io/BufferedInputStream.h"
#include "java/io/BufferedOutputStream.h"
#include "java/io/BufferedReader.h"
#include "java/io/ByteArrayInputStream.h"
#include "java/io/File.h"
#include "java/io/FileInputStream.h"
#include "java/io/FileOutputStream.h"
#include "java/io/IOException.h"
#include "java/io/InputStreamReader.h"
#include "java/lang/StringBuilder.h"
#include "java/lang/Thread.h"
#include "java/util/zip/ZipEntry.h"
#include "java/util/zip/ZipInputStream.h"
#include "org/minima/objects/base/MiniData.h"
#include "org/minima/system/Main.h"
#include "org/minima/system/SystemHandler.h"
#include "org/minima/system/backup/BackupManager.h"
#include "org/minima/system/network/minidapps/DAPPManager.h"
#include "org/minima/system/network/minidapps/DAPPServer.h"
#include "org/minima/utils/Crypto.h"
#include "org/minima/utils/json/JSONArray.h"
#include "org/minima/utils/json/JSONObject.h"
#include "org/minima/utils/json/parser/JSONParser.h"
#include "org/minima/utils/json/parser/ParseException.h"
#include "org/minima/utils/messages/Message.h"

NSString *OrgMinimaSystemNetworkMinidappsDAPPManager_DAPP_INSTALL = @"DAPP_INSTALL";

@implementation OrgMinimaSystemNetworkMinidappsDAPPManager

- (instancetype)initWithOrgMinimaSystemMain:(OrgMinimaSystemMain *)zMain
                                    withInt:(jint)zPort {
  OrgMinimaSystemNetworkMinidappsDAPPManager_initWithOrgMinimaSystemMain_withInt_(self, zMain, zPort);
  return self;
}

- (void)stop {
  [((OrgMinimaSystemNetworkMinidappsDAPPServer *) nil_chk(mDAPPServer_)) stop];
  [self stopMessageProcessor];
}

- (OrgMinimaUtilsJsonJSONArray *)getMiniDAPPS {
  return CURRENT_MINIDAPPS_;
}

- (NSString *)getMiniDAPPSFolder {
  return MINIDAPPS_FOLDER_;
}

- (OrgMinimaUtilsJsonJSONObject *)loadConfFileWithJavaIoFile:(JavaIoFile *)zConf {
  OrgMinimaUtilsJsonJSONObject *ret = new_OrgMinimaUtilsJsonJSONObject_init();
  @try {
    JavaLangStringBuilder *tot = new_JavaLangStringBuilder_init();
    JavaIoFileInputStream *fis = new_JavaIoFileInputStream_initWithJavaIoFile_(zConf);
    JavaIoInputStreamReader *is = new_JavaIoInputStreamReader_initWithJavaIoInputStream_(fis);
    JavaIoBufferedReader *bis = new_JavaIoBufferedReader_initWithJavaIoReader_(is);
    NSString *sCurrentLine;
    while ((sCurrentLine = [bis readLine]) != nil) {
      (void) [((JavaLangStringBuilder *) nil_chk([tot appendWithNSString:sCurrentLine])) appendWithNSString:@"\n"];
    }
    OrgMinimaUtilsJsonParserJSONParser *parser = new_OrgMinimaUtilsJsonParserJSONParser_init();
    ret = (OrgMinimaUtilsJsonJSONObject *) cast_chk([parser parseWithNSString:[tot description]], [OrgMinimaUtilsJsonJSONObject class]);
    NSString *root = [((JavaIoFile *) nil_chk(zConf)) getParent];
    jint start = [((NSString *) nil_chk(root)) java_indexOfString:@"/minidapps/"];
    NSString *webroot = [root java_substring:start];
    NSString *approot = [root java_substring:start + 11];
    jint firstfolder = [((NSString *) nil_chk(approot)) java_indexOfString:@"/"];
    if (firstfolder != -1) {
      approot = [approot java_substring:0 endIndex:firstfolder];
    }
    (void) [((OrgMinimaUtilsJsonJSONObject *) nil_chk(ret)) putWithId:@"root" withId:webroot];
    (void) [ret putWithId:@"approot" withId:approot];
    [bis close];
    [fis close];
  }
  @catch (JavaIoIOException *e) {
    [e printStackTrace];
  }
  @catch (OrgMinimaUtilsJsonParserParseException *e) {
    [e printStackTrace];
  }
  return ret;
}

- (OrgMinimaUtilsJsonJSONArray *)recalculateMiniDAPPS {
  [((OrgMinimaUtilsJsonJSONArray *) nil_chk(CURRENT_MINIDAPPS_)) clear];
  NSString *root = [((OrgMinimaSystemBackupBackupManager *) nil_chk([((OrgMinimaSystemMain *) nil_chk([self getMainHandler])) getBackupManager])) getRootFolder];
  JavaIoFile *alldapps = new_JavaIoFile_initWithNSString_withNSString_(root, @"minidapps");
  if (![alldapps exists]) {
    [alldapps mkdirs];
  }
  MINIDAPPS_FOLDER_ = [alldapps getAbsolutePath];
  IOSObjectArray *apps = [alldapps listFiles];
  if (apps != nil) {
    {
      IOSObjectArray *a__ = apps;
      JavaIoFile * const *b__ = a__->buffer_;
      JavaIoFile * const *e__ = b__ + a__->size_;
      while (b__ < e__) {
        JavaIoFile *app = *b__++;
        JavaIoFile *conf = new_JavaIoFile_initWithJavaIoFile_withNSString_(app, @"minidapp.conf");
        if (![conf exists]) {
          IOSObjectArray *subapps = [((JavaIoFile *) nil_chk(app)) listFiles];
          if (subapps != nil) {
            if ([((JavaIoFile *) nil_chk(IOSObjectArray_Get(subapps, 0))) isDirectory]) {
              conf = new_JavaIoFile_initWithJavaIoFile_withNSString_(IOSObjectArray_Get(subapps, 0), @"minidapp.conf");
            }
          }
        }
        if ([conf exists]) {
          OrgMinimaUtilsJsonJSONObject *confjson = [self loadConfFileWithJavaIoFile:conf];
          [((OrgMinimaUtilsJsonJSONArray *) nil_chk(CURRENT_MINIDAPPS_)) addWithId:confjson];
        }
      }
    }
  }
  return CURRENT_MINIDAPPS_;
}

- (void)processMessageWithOrgMinimaUtilsMessagesMessage:(OrgMinimaUtilsMessagesMessage *)zMessage {
  if ([((NSString *) nil_chk([((OrgMinimaUtilsMessagesMessage *) nil_chk(zMessage)) getMessageType])) isEqual:OrgMinimaSystemNetworkMinidappsDAPPManager_DAPP_INSTALL]) {
    OrgMinimaObjectsBaseMiniData *data = (OrgMinimaObjectsBaseMiniData *) cast_chk([zMessage getObjectWithNSString:@"minidapp"], [OrgMinimaObjectsBaseMiniData class]);
    OrgMinimaObjectsBaseMiniData *hash_ = [((OrgMinimaUtilsCrypto *) nil_chk(OrgMinimaUtilsCrypto_getInstance())) hashObjectWithOrgMinimaUtilsStreamable:data withInt:160];
    NSString *root = [((OrgMinimaSystemBackupBackupManager *) nil_chk([((OrgMinimaSystemMain *) nil_chk([self getMainHandler])) getBackupManager])) getRootFolder];
    JavaIoFile *alldapps = new_JavaIoFile_initWithNSString_withNSString_(root, @"minidapps");
    JavaIoFile *dapp = new_JavaIoFile_initWithJavaIoFile_withNSString_(alldapps, [((OrgMinimaObjectsBaseMiniData *) nil_chk(hash_)) to0xString]);
    [dapp mkdirs];
    IOSByteArray *buffer = [IOSByteArray newArrayWithLength:2048];
    JavaIoByteArrayInputStream *bais = new_JavaIoByteArrayInputStream_initWithByteArray_([((OrgMinimaObjectsBaseMiniData *) nil_chk(data)) getData]);
    JavaIoBufferedInputStream *bis = new_JavaIoBufferedInputStream_initWithJavaIoInputStream_(bais);
    JavaUtilZipZipInputStream *stream = new_JavaUtilZipZipInputStream_initWithJavaIoInputStream_(bis);
    JavaUtilZipZipEntry *entry_ = nil;
    while ((entry_ = [stream getNextEntry]) != nil) {
      JavaIoFile *filePath = new_JavaIoFile_initWithJavaIoFile_withNSString_(dapp, [((JavaUtilZipZipEntry *) nil_chk(entry_)) getName]);
      JavaIoFile *parent = [filePath getParentFile];
      if (![((JavaIoFile *) nil_chk(parent)) exists]) {
        [parent mkdirs];
      }
      if ([entry_ isDirectory]) {
        [filePath mkdirs];
      }
      else {
        if ([filePath exists]) {
          [filePath delete__];
        }
        JavaIoFileOutputStream *fos = new_JavaIoFileOutputStream_initWithJavaIoFile_(filePath);
        JavaIoBufferedOutputStream *bos = new_JavaIoBufferedOutputStream_initWithJavaIoOutputStream_withInt_(fos, buffer->size_);
        jint len;
        while ((len = [stream readWithByteArray:buffer]) > 0) {
          [bos writeWithByteArray:buffer withInt:0 withInt:len];
        }
        [bos flush];
      }
    }
    (void) [self recalculateMiniDAPPS];
  }
}

+ (const J2ObjcClassInfo *)__metadata {
  static J2ObjcMethodInfo methods[] = {
    { NULL, NULL, 0x1, -1, 0, -1, -1, -1, -1 },
    { NULL, "V", 0x1, -1, -1, -1, -1, -1, -1 },
    { NULL, "LOrgMinimaUtilsJsonJSONArray;", 0x1, -1, -1, -1, -1, -1, -1 },
    { NULL, "LNSString;", 0x1, -1, -1, -1, -1, -1, -1 },
    { NULL, "LOrgMinimaUtilsJsonJSONObject;", 0x1, 1, 2, -1, -1, -1, -1 },
    { NULL, "LOrgMinimaUtilsJsonJSONArray;", 0x1, -1, -1, -1, -1, -1, -1 },
    { NULL, "V", 0x4, 3, 4, 5, -1, -1, -1 },
  };
  #pragma clang diagnostic push
  #pragma clang diagnostic ignored "-Wobjc-multiple-method-names"
  #pragma clang diagnostic ignored "-Wundeclared-selector"
  methods[0].selector = @selector(initWithOrgMinimaSystemMain:withInt:);
  methods[1].selector = @selector(stop);
  methods[2].selector = @selector(getMiniDAPPS);
  methods[3].selector = @selector(getMiniDAPPSFolder);
  methods[4].selector = @selector(loadConfFileWithJavaIoFile:);
  methods[5].selector = @selector(recalculateMiniDAPPS);
  methods[6].selector = @selector(processMessageWithOrgMinimaUtilsMessagesMessage:);
  #pragma clang diagnostic pop
  static const J2ObjcFieldInfo fields[] = {
    { "DAPP_INSTALL", "LNSString;", .constantValue.asLong = 0, 0x9, -1, 6, -1, -1 },
    { "CURRENT_MINIDAPPS_", "LOrgMinimaUtilsJsonJSONArray;", .constantValue.asLong = 0, 0x0, -1, -1, -1, -1 },
    { "MINIDAPPS_FOLDER_", "LNSString;", .constantValue.asLong = 0, 0x0, -1, -1, -1, -1 },
    { "mDAPPServer_", "LOrgMinimaSystemNetworkMinidappsDAPPServer;", .constantValue.asLong = 0, 0x0, -1, -1, -1, -1 },
  };
  static const void *ptrTable[] = { "LOrgMinimaSystemMain;I", "loadConfFile", "LJavaIoFile;", "processMessage", "LOrgMinimaUtilsMessagesMessage;", "LJavaLangException;", &OrgMinimaSystemNetworkMinidappsDAPPManager_DAPP_INSTALL };
  static const J2ObjcClassInfo _OrgMinimaSystemNetworkMinidappsDAPPManager = { "DAPPManager", "org.minima.system.network.minidapps", ptrTable, methods, fields, 7, 0x1, 7, 4, -1, -1, -1, -1, -1 };
  return &_OrgMinimaSystemNetworkMinidappsDAPPManager;
}

@end

void OrgMinimaSystemNetworkMinidappsDAPPManager_initWithOrgMinimaSystemMain_withInt_(OrgMinimaSystemNetworkMinidappsDAPPManager *self, OrgMinimaSystemMain *zMain, jint zPort) {
  OrgMinimaSystemSystemHandler_initWithOrgMinimaSystemMain_withNSString_(self, zMain, @"DAPPMAnager");
  self->CURRENT_MINIDAPPS_ = new_OrgMinimaUtilsJsonJSONArray_init();
  self->MINIDAPPS_FOLDER_ = @"";
  (void) [self recalculateMiniDAPPS];
  self->mDAPPServer_ = new_OrgMinimaSystemNetworkMinidappsDAPPServer_initWithInt_withOrgMinimaSystemNetworkMinidappsDAPPManager_(zPort, self);
  JavaLangThread *tt = new_JavaLangThread_initWithJavaLangRunnable_(self->mDAPPServer_);
  [tt start];
}

OrgMinimaSystemNetworkMinidappsDAPPManager *new_OrgMinimaSystemNetworkMinidappsDAPPManager_initWithOrgMinimaSystemMain_withInt_(OrgMinimaSystemMain *zMain, jint zPort) {
  J2OBJC_NEW_IMPL(OrgMinimaSystemNetworkMinidappsDAPPManager, initWithOrgMinimaSystemMain_withInt_, zMain, zPort)
}

OrgMinimaSystemNetworkMinidappsDAPPManager *create_OrgMinimaSystemNetworkMinidappsDAPPManager_initWithOrgMinimaSystemMain_withInt_(OrgMinimaSystemMain *zMain, jint zPort) {
  J2OBJC_CREATE_IMPL(OrgMinimaSystemNetworkMinidappsDAPPManager, initWithOrgMinimaSystemMain_withInt_, zMain, zPort)
}

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(OrgMinimaSystemNetworkMinidappsDAPPManager)
